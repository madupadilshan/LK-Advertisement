name: Deploy to VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

    - name: Build and push Backend
      uses: docker/build-push-action@v4
      with:
        context: ./Lk_Advertisement_backend
        push: true
        tags: ${{ secrets.DOCKER_HUB_USERNAME }}/lk-ads-backend:latest

    - name: Build and push Frontend
      uses: docker/build-push-action@v4
      with:
        context: ./Lk_Advertisement_frontend
        push: true
        tags: ${{ secrets.DOCKER_HUB_USERNAME }}/lk-ads-frontend:latest
        build-args:
          VITE_API_BASE_URL: http://${{ secrets.VPS_IP }}:8081/api

    - name: Deploy to VPS
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_IP }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        script: |
          # Stop existing containers
          docker stop lk_ads_backend lk_ads_frontend || true
          docker rm lk_ads_backend lk_ads_frontend || true

          # Pull new images
          docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/lk-ads-backend:latest
          docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/lk-ads-frontend:latest

          # Run Backend
          docker run -d \
            --name lk_ads_backend \
            -p 8081:8080 \
            -e SPRING_DATASOURCE_URL="jdbc:mysql://${{ secrets.VPS_IP }}:3306/lk_ads_db?useSSL=false&serverTimezone=UTC" \
            -e SPRING_DATASOURCE_USERNAME="${{ secrets.DB_USERNAME }}" \
            -e SPRING_DATASOURCE_PASSWORD="${{ secrets.DB_PASSWORD }}" \
            --restart always \
            ${{ secrets.DOCKER_HUB_USERNAME }}/lk-ads-backend:latest

          # Run Frontend
          docker run -d \
            --name lk_ads_frontend \
            -p 5173:80 \
            --restart always \
            ${{ secrets.DOCKER_HUB_USERNAME }}/lk-ads-frontend:latest
